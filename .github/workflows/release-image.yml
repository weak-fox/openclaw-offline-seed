name: Release Image

on:
  push:
    tags:
      - v*
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish-ghcr:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag

      - name: Resolve OpenClaw base image
        id: base
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          if [[ "$REF_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-oc-([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            openclaw_version="${BASH_REMATCH[1]}"
            openclaw_image="ghcr.io/openclaw/openclaw:${openclaw_version}"
          else
            openclaw_image="$(awk -F= '/^ARG OPENCLAW_IMAGE=/{print $2; exit}' Dockerfile)"
          fi

          if [ -z "$openclaw_image" ]; then
            echo "Failed to resolve OPENCLAW_IMAGE"
            exit 1
          fi

          echo "openclaw_image=$openclaw_image" >> "$GITHUB_OUTPUT"
          echo "Using OPENCLAW_IMAGE=$openclaw_image"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            OPENCLAW_IMAGE=${{ steps.base.outputs.openclaw_image }}
            SEED_CONFIG=config/seed-config.json
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
